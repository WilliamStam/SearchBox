/**
 * MIT License
 * 
 * Copyright (c) 2017+ William Stam
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
jQuery.fn.selectText=function(e,t){var s,o;return this.each(function(){document.body.createTextRange?(s=document.body.createTextRange(),s.moveToElementText(this),s.moveStart("character",e),s.collapse(!0),s.moveEnd("character",t),s.select()):window.getSelection&&(o=window.getSelection(),s=document.createRange(),s.setStart(this.firstChild,e),s.setEnd(this.firstChild,t),o.removeAllRanges(),o.addRange(s))})},function(e,t,s,o){function a(t,s){this.element=t,this.options=e.extend({},i,s),this._defaults=i,this._name=n,this.init()}var n="searchbox",i={data:{smile:{records:[{smile:"tongue",shortcode:":stuck_out_tongue:"},{smile:"crazy_tongue",shortcode:":stuck_out_tongue_winking_eye:"},{smile:"winking",shortcode:":stuck_out_tongue_winking_eye:"}],field:"smile",template:"<div data-value='@@smile@@'>@@shortcode@@</div>"},test:{records:[{smile:"tongue",shortcode:":stuck_out_tongue:"},{smile:"crazy_tongue",shortcode:":stuck_out_tongue_winking_eye:"},{smile:"winking",shortcode:":stuck_out_tongue_winking_eye:"}],field:"smile",template:"<div>@@shortcode@@</div>"}},tagClass:"sb-tag",tagValueClass:"sb-value",template:"<div>@@item@@</div>",maxHeight:200,selectFirstSuggestionOnSpace:!0};a.prototype={init:function(){var t=this;t.element=e(t.element),t.searchbox=e('<div class="searchbox-sb" contenteditable="true"></div>'),t.suggestions=e('<div class="searchbox-sb-suggestion"><div class="searchbox-sb-suggestion-header"></div><div class="searchbox-sb-suggestion-items"></div><div class="searchbox-sb-suggestion-footer"></div></div>'),t.element.on("change",function(e){t.tagify()}),t.searchbox.on("keyup",function(e){t.typing(e)}),t.suggestions.on("click",".searchbox-sb-suggestion-items > *",function(s){var o=e(this),a=o.attr("data-value");console.log(a),t.searchbox.data("sb-new-val",a),t.searchbox.get(0).focus(),t.suggestions.hide()}),t.searchbox.on("mousedown",function(s){var o=e(this);o.text();if(e(s.target).hasClass(t.options.tagClass)){var a=e(s.target).attr("data-sb-lookup"),n=e(s.target).prevAll("."+t.options.tagClass+"[data-sb-lookup='"+a+"']").length;o.data("sb-select",{lookup:a,index:n})}if(e(s.target).hasClass(t.options.tagValueClass)){var a=e(s.target).parent().attr("data-sb-lookup"),n=e(s.target).parent().prevAll("."+t.options.tagClass+"[data-sb-lookup='"+a+"']").length;o.data("sb-select",{lookup:a,index:n})}}),t.searchbox.on("focus",function(s){var o=e(this),a=e(t.element).val(),n=o.caret("pos");if(o.text(a),o.caret("pos",n),o.data("sb-select")){var i=o.data("sb-select"),l=o.caret("pos"),r=a.indexOf(" ",l);r=r==-1?a.length:r;var c=a.slice(0,r).lastIndexOf(":");t.searchbox.selectText(c+1,r);var g=a.slice(c+1,r);t.suggest(i.lookup,g,l),o.data("sb-select",!1)}if(o.data("sb-suggest")&&o.data("sb-new-val")){var d=o.data("sb-suggest"),l=d.pos,r=a.indexOf(" ",l);r=r==-1?a.length:r;var c=a.slice(0,r).lastIndexOf(":")+1,g=a.slice(c,r);console.log("suggestion clicked");var u=o.data("sb-new-val");console.log({start:c,end:r,length:a.length,replace:g,with:u});var h=a.substring(0,c),s=a.substring(r,a.length);a=h+u+s,console.info({s:h,e:s,txt:a}),o.text(a),e(t.element).val(a),o.caret("pos",c+u.length),o.data("sb-suggest",!1),o.data("sb-new-val",!1)}}),t.searchbox.on("blur",function(){t.tagify(),setTimeout(function(){t.suggestions.hide()},100)}),t.tagify(),t.element.wrap('<div class="searchbox-sb-container"></div>'),t.element.before(t.searchbox),t.element.after(t.suggestions)},tagify:function(){var t=e(this.element).val(),s=t;for(var o in this.options.data)for(var a,n=o,i=n+":([^-\\s]*)",l=new RegExp(i,"g");null!==(a=l.exec(t));){var r=a[0],c=r.replace(n+":",""),g=n+':<span class="'+this.options.tagValueClass+'">'+c+"</span>";s=s.replace(a[0],'<span class="'+this.options.tagClass+'" data-sb-lookup="'+n+'">'+g+"</span>")}this.searchbox.html(s),e(this.element).trigger("sb-change")},typing:function(t){var s=this;s.element=e(s.element);var o=s.searchbox.text();console.log("begining: ["+o+"] | keycode: ["+t.keyCode+"]");var a=s.searchbox.caret("pos"),n="",i=o,l=a,r=i.slice(0,l).search(/\S+$/),c=i.slice(l).search(/\s/);if(n=c<0?i.slice(r):i.slice(r,c+l),!t.shiftKey){if(n.indexOf(":")!=-1){var g=n.split(":"),d=g[0],u=g[1];s.suggest(d,u,a)}else s.suggestions.hide();if(s.options.selectFirstSuggestionOnSpace&&(console.log(l),32==t.keyCode&&(l-=1,r=i.slice(0,l).search(/\S+$/),c=i.slice(l).search(/\s/),n=c<0?i.slice(r):i.slice(r,c+l),console.log("key:"+t.keyCode+" | specialcase:"+n),n.indexOf(":")!=-1))){var g=n.split(":"),d=g[0],u=g[1];console.log({lookup:d,val:u});var h=e.grep(s.options.data[d].records,function(e,t){var o=e[s.options.data[d].field].replace(/\s+/g," ").toLowerCase(),a=!0;return u&&(a=o.indexOf(u)=!1,console.log(a)),console.log("VAL: "+u+" | TEXT:"+o+" | RET:"+a+" | indexOf:"+o.indexOf(u)),a}),p=h[0][s.options.data[d].field];if(console.log(h),p&&""==u){console.log("new val:"+p);var v=i.slice(0,l),f=i.slice(l+1,i.length);o=v+p+" "+f,s.searchbox.text(o);var b=v+p;b=b.length,s.searchbox.caret("pos",b),s.searchbox.caret("pos",s.searchbox.caret("pos")+1),console.log("check pos:"+s.searchbox.caret("pos")),console.log({stxt:v,newval:p,etxt:f,txt:o,pos:l,newpos:b,"newval len":p.length,"txt len":o.length})}}}console.log("saving: ["+o+"]"),console.log("--------------------------"),s.element.val(o).trigger("sb-change")},suggest:function(t,s,o){var a=this,n=a.suggestions.find(".searchbox-sb-suggestion-items"),i=a.suggestions.find(".searchbox-sb-suggestion-header"),l=a.suggestions.find(".searchbox-sb-suggestion-footer");if(a.searchbox.data("sb-suggest",{lookup:t,pos:o}),"undefined"!=typeof a.options.data[t]){var r=a.options.data[t];i.html("looking up <strong>"+t+"</strong> for <strong>"+s+"</strong>");var c=r.records.map(function(t){var s=r.template||a.options.template;for(var o in t){var n="@@"+o+"@@";n=n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");var i=new RegExp(n,"g");s=s.replace(i,t[o])}return s=e("<div/>").html(s).contents(),s.attr("data-value",t[r.field]),s=s.prop("outerHTML")});n.html(c),s=e.trim(s).replace(/ +/g," ").toLowerCase();var g=n.children(),d=0;g.show().filter(function(){var t=e(this).attr("data-value").replace(/\s+/g," ").toLowerCase();return t.indexOf(s)!=-1&&(d+=1),!~t.indexOf(s)}).hide(),l.html("found: <strong>"+d+"</strong>"),a.suggestions.show()}}},e.fn[n]=function(t){return this.each(function(){e.data(this,"plugin_"+n)||e.data(this,"plugin_"+n,new a(this,t))})}}(jQuery,window,document);
//# sourceMappingURL=jquery.searchbox.min.js.map
